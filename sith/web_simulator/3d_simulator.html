<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SITH - 3D R2-D2 Simulator</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', 'Courier New', monospace;
            background: radial-gradient(ellipse at center, #1a0000 0%, #000000 100%);
            color: #ff0000;
            overflow: hidden;
            text-shadow: 0 0 10px #ff0000;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 400px;
            height: 100vh;
        }

        .viewer-section {
            position: relative;
            background: radial-gradient(ellipse at center, #1a0000 0%, #000000 100%);
            border: 2px solid #ff0000;
            box-shadow: 
                inset 0 0 50px rgba(255, 0, 0, 0.2),
                0 0 50px rgba(255, 0, 0, 0.3);
        }

        #threejs-container {
            width: 100%;
            height: 100%;
        }

        .controls-section {
            background: linear-gradient(135deg, rgba(40, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.95) 100%);
            border-left: 2px solid #ff0000;
            padding: 20px;
            backdrop-filter: blur(10px);
            overflow-y: auto;
            box-shadow: 
                inset 0 0 30px rgba(255, 0, 0, 0.2),
                -10px 0 30px rgba(0, 0, 0, 0.5);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 
                0 0 10px #ff0000,
                0 0 20px #ff0000,
                0 0 30px #ff0000,
                0 0 40px #ff0000;
            color: #ff0000;
            font-weight: 900;
            letter-spacing: 2px;
        }

        .header p {
            opacity: 0.8;
            color: #ff6666;
            text-shadow: 0 0 5px #ff6666;
            font-size: 0.9em;
        }

        .control-panel {
            background: linear-gradient(135deg, rgba(40, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.9) 100%);
            border: 1px solid #ff0000;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 
                0 0 20px rgba(255, 0, 0, 0.2),
                inset 0 0 20px rgba(255, 0, 0, 0.1);
        }

        .control-panel h3 {
            margin-bottom: 15px;
            color: #ff0000;
            font-size: 1.3em;
            text-shadow: 0 0 10px #ff0000;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .command-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .command-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ff0000;
            border-radius: 8px;
            font-size: 1em;
            background: rgba(0, 0, 0, 0.8);
            color: #ff0000;
            font-family: 'Orbitron', monospace;
            text-shadow: 0 0 5px #ff0000;
            box-shadow: 
                inset 0 0 10px rgba(255, 0, 0, 0.2),
                0 0 10px rgba(255, 0, 0, 0.3);
        }

        .command-input input:focus {
            outline: none;
            box-shadow: 
                inset 0 0 15px rgba(255, 0, 0, 0.3),
                0 0 20px rgba(255, 0, 0, 0.5);
        }

        .command-input button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            color: #000;
            border: 2px solid #ff0000;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            text-shadow: none;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.4);
        }

        .command-input button:hover {
            background: linear-gradient(135deg, #ff3333 0%, #ff0000 100%);
            box-shadow: 0 0 25px rgba(255, 0, 0, 0.7);
            transform: translateY(-2px);
        }

        .quick-commands h4 {
            margin-bottom: 10px;
            color: #00d4ff;
            text-shadow: 0 0 10px #00d4ff;
            font-weight: 600;
        }

        .command-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .cmd-btn {
            padding: 10px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(0, 0, 0, 0.8) 100%);
            color: #00d4ff;
            border: 1px solid #00d4ff;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-family: 'Orbitron', monospace;
            font-weight: 600;
            transition: all 0.3s ease;
            text-shadow: 0 0 5px #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.2);
        }

        .cmd-btn:hover {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.4) 0%, rgba(0, 0, 0, 0.9) 100%);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
            transform: translateY(-2px);
            text-shadow: 0 0 10px #00d4ff;
        }

        .sequence-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .sequence-controls button {
            padding: 12px;
            background: linear-gradient(135deg, rgba(255, 0, 150, 0.3) 0%, rgba(0, 0, 0, 0.8) 100%);
            color: #ff0096;
            border: 1px solid #ff0096;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-family: 'Orbitron', monospace;
            font-weight: 600;
            transition: all 0.3s ease;
            text-shadow: 0 0 5px #ff0096;
            box-shadow: 0 0 10px rgba(255, 0, 150, 0.2);
        }

        .sequence-controls button:hover:not(:disabled) {
            background: linear-gradient(135deg, rgba(255, 0, 150, 0.5) 0%, rgba(0, 0, 0, 0.9) 100%);
            box-shadow: 0 0 20px rgba(255, 0, 150, 0.4);
            transform: translateY(-2px);
            text-shadow: 0 0 10px #ff0096;
        }

        .sequence-controls button:disabled {
            background: rgba(100, 100, 100, 0.3);
            color: #666;
            border-color: #666;
            cursor: not-allowed;
            opacity: 0.5;
            text-shadow: none;
            box-shadow: none;
        }

        .panel-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }

        .panel-btn {
            aspect-ratio: 1;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 30, 60, 0.6) 100%);
            border: 2px solid #00d4ff;
            border-radius: 8px;
            color: #00d4ff;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Orbitron', monospace;
            text-shadow: 0 0 5px #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.2);
        }

        .panel-btn:hover {
            background: linear-gradient(135deg, rgba(0, 30, 60, 0.8) 0%, rgba(0, 0, 0, 0.9) 100%);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.4);
            transform: scale(1.05);
        }

        .panel-btn.active {
            background: linear-gradient(135deg, rgba(0, 255, 0, 0.3) 0%, rgba(0, 100, 0, 0.6) 100%);
            border-color: #00ff00;
            color: #00ff00;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.6);
            text-shadow: 0 0 10px #00ff00;
        }

        .status-bar {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 30, 60, 0.6) 100%);
            border: 1px solid #00d4ff;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 
                0 0 15px rgba(0, 212, 255, 0.1),
                inset 0 0 15px rgba(0, 212, 255, 0.05);
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .log-section {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(0, 20, 40, 0.8) 100%);
            border: 1px solid #00d4ff;
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 
                0 0 10px rgba(0, 212, 255, 0.1),
                inset 0 0 10px rgba(0, 212, 255, 0.05);
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.5);
            font-family: 'Orbitron', monospace;
            font-size: 0.9em;
            color: #00d4ff;
            text-shadow: 0 0 3px #00d4ff;
        }

        .log-entry.success {
            background: rgba(0, 255, 0, 0.1);
            border-left: 3px solid #00ff00;
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00;
        }

        .log-entry.error {
            background: rgba(255, 0, 0, 0.1);
            border-left: 3px solid #ff0000;
            color: #ff0000;
            text-shadow: 0 0 5px #ff0000;
        }

        .log-entry.info {
            background: rgba(0, 212, 255, 0.1);
            border-left: 3px solid #00d4ff;
            color: #00d4ff;
            text-shadow: 0 0 5px #00d4ff;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
        }

        .loading h2 {
            margin-bottom: 20px;
            color: #00d4ff;
            text-shadow: 0 0 20px #00d4ff;
            font-family: 'Orbitron', monospace;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 212, 255, 0.3);
            border-top: 5px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .viewer-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
        }

        .viewer-controls button {
            display: block;
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 30, 60, 0.6) 100%);
            color: #00d4ff;
            border: 1px solid #00d4ff;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-weight: 600;
            text-shadow: 0 0 5px #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.2);
            transition: all 0.3s ease;
        }

        .viewer-controls button:hover {
            background: linear-gradient(135deg, rgba(0, 30, 60, 0.8) 0%, rgba(0, 0, 0, 0.9) 100%);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.4);
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 400px;
            }
            
            .command-buttons {
                grid-template-columns: 1fr;
            }
            
            .sequence-controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 3D Viewer Section -->
        <div class="viewer-section">
            <div id="threejs-container"></div>
            <div class="loading" id="loading">
                <h2>🤖 Loading R2-D2...</h2>
                <div class="spinner"></div>
                <p>Initializing 3D model and controls</p>
            </div>
            <div class="viewer-controls">
                <button onclick="resetCamera()">Reset View</button>
                <button onclick="toggleWireframe()">Wireframe</button>
                <button onclick="toggleLights()">Lights</button>
                <button onclick="toggleAnimation()">Animation</button>
            </div>
        </div>

        <!-- Controls Section -->
        <div class="controls-section">
            <div class="header">
                <h1>🤖 SITH 3D Simulator</h1>
                <p>Interactive 3D R2-D2 Control</p>
            </div>

            <!-- Shadow Commands -->
            <div class="control-panel">
                <h3>Shadow Commands</h3>
                <div class="command-input">
                    <input type="text" id="commandInput" placeholder="Enter command (e.g., :OP01)" value=":OP01">
                    <button id="sendCommand">Send</button>
                </div>
                
                <div class="quick-commands">
                    <h4>Quick Commands:</h4>
                    <div class="command-buttons">
                        <button class="cmd-btn" data-cmd=":OP00">Open All</button>
                        <button class="cmd-btn" data-cmd=":CL00">Close All</button>
                        <button class="cmd-btn" data-cmd=":SE02">Wave Sequence</button>
                        <button class="cmd-btn" data-cmd=":SE03">Scream Sequence</button>
                        <button class="cmd-btn" data-cmd="*H005">HP Flash</button>
                        <button class="cmd-btn" data-cmd="@0T5">Scream Display</button>
                        <button class="cmd-btn" data-cmd="$S">Scream Sound</button>
                        <button class="cmd-btn" data-cmd="#RST">Reset</button>
                    </div>
                </div>
            </div>

            <!-- Panel Control -->
            <div class="control-panel">
                <h3>Panel Control</h3>
                <div class="panel-grid" id="panelGrid">
                    <!-- Panels will be generated by JavaScript -->
                </div>
            </div>

            <!-- Sequence Control -->
            <div class="control-panel">
                <h3>Sequence Control</h3>
                <div class="sequence-controls">
                    <button id="loadWaveSequence">Load Wave</button>
                    <button id="loadScreamSequence">Load Scream</button>
                    <button id="startSequence" disabled>Start</button>
                    <button id="stopSequence" disabled>Stop</button>
                </div>
            </div>

            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-item">
                    <span>Status:</span>
                    <span id="statusText">Ready</span>
                </div>
                <div class="status-item">
                    <span>Panels Open:</span>
                    <span id="panelCount">0 / 16</span>
                </div>
                <div class="status-item">
                    <span>Commands:</span>
                    <span id="commandCount">0</span>
                </div>
            </div>

            <!-- Command Log -->
            <div class="log-section" id="commandLog">
                <div class="log-entry">Ready to receive commands...</div>
            </div>
        </div>
    </div>

    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <!-- Fallback for OrbitControls if CDN fails -->
    <script>
        if (typeof THREE !== 'undefined' && !THREE.OrbitControls) {
            // Simple fallback OrbitControls implementation
            THREE.OrbitControls = function(camera, domElement) {
                this.camera = camera;
                this.domElement = domElement;
                this.enableDamping = true;
                this.dampingFactor = 0.05;
                this.maxPolarAngle = Math.PI / 2;
                
                this.update = function() {
                    // Simple rotation
                    this.camera.position.x = Math.cos(Date.now() * 0.0005) * 10;
                    this.camera.position.z = Math.sin(Date.now() * 0.0005) * 10;
                    this.camera.lookAt(0, 0, 0);
                };
                
                this.reset = function() {
                    this.camera.position.set(0, 5, 10);
                    this.camera.lookAt(0, 0, 0);
                };
            };
        }
    </script>

    <script>
        // SITH 3D R2-D2 Simulator
        class SITH3DSimulator {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.controls = null;
                this.r2d2 = null;
                this.panels = [];
                this.currentSequence = null;
                this.isRunning = false;
                this.commandCount = 0;
                this.animationId = null;
                this.wireframe = false;
                this.lightsOn = true;
                this.animationEnabled = true;
                
                this.initializeEventListeners();
                this.initialize3D();
                
                // Create R2-D2 model after a short delay to ensure 3D is ready
                setTimeout(() => {
                    this.createR2D2Model();
                }, 100);
                
                // Fallback timeout to hide loading screen
                setTimeout(() => {
                    const loading = document.getElementById('loading');
                    if (loading.style.display !== 'none') {
                        console.warn('Loading timeout - forcing display');
                        loading.style.display = 'none';
                    }
                }, 5000);
            }
            
            initializeEventListeners() {
                // Command input
                document.getElementById('commandInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendCommand();
                    }
                });
                
                document.getElementById('sendCommand').addEventListener('click', () => {
                    this.sendCommand();
                });
                
                // Quick command buttons
                document.querySelectorAll('.cmd-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const command = e.target.getAttribute('data-cmd');
                        document.getElementById('commandInput').value = command;
                        this.sendCommand();
                    });
                });
                
                // Sequence controls
                document.getElementById('loadWaveSequence').addEventListener('click', () => {
                    this.loadWaveSequence();
                });
                
                document.getElementById('loadScreamSequence').addEventListener('click', () => {
                    this.loadScreamSequence();
                });
                
                document.getElementById('startSequence').addEventListener('click', () => {
                    this.startSequence();
                });
                
                document.getElementById('stopSequence').addEventListener('click', () => {
                    this.stopSequence();
                });
            }
            
            initialize3D() {
                try {
                    console.log('Initializing 3D scene...');
                    
                    // Check if Three.js is loaded
                    if (typeof THREE === 'undefined') {
                        throw new Error('Three.js not loaded');
                    }
                    
                    // Create scene
                    this.scene = new THREE.Scene();
                    this.scene.background = new THREE.Color(0x000000);
                    
                    // Add starfield
                    this.createStarfield();
                    
                    // Create camera
                    this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                    this.camera.position.set(0, 5, 10);
                    
                    // Create renderer
                    const container = document.getElementById('threejs-container');
                    this.renderer = new THREE.WebGLRenderer({ antialias: true });
                    this.renderer.setSize(container.clientWidth, container.clientHeight);
                    this.renderer.shadowMap.enabled = true;
                    this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                    container.appendChild(this.renderer.domElement);
                    
                    // Add controls
                    this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                    this.controls.enableDamping = true;
                    this.controls.dampingFactor = 0.05;
                    this.controls.maxPolarAngle = Math.PI / 2;
                    
                    // Add lighting
                    this.setupLighting();
                    
                    // Add ground
                    this.addGround();
                    
                    // Handle window resize
                    window.addEventListener('resize', () => this.onWindowResize());
                    
                    // Start animation loop
                    this.animate();
                    
                    console.log('3D scene initialized successfully');
                } catch (error) {
                    console.error('Error initializing 3D scene:', error);
                    this.showError('Failed to initialize 3D scene: ' + error.message);
                }
            }
            
            setupLighting() {
                // Ambient light
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                this.scene.add(ambientLight);
                
                // Main directional light
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(10, 10, 5);
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 2048;
                directionalLight.shadow.mapSize.height = 2048;
                this.scene.add(directionalLight);
                
                // Fill light
                const fillLight = new THREE.DirectionalLight(0x4a90e2, 0.3);
                fillLight.position.set(-10, 5, -5);
                this.scene.add(fillLight);
                
                // Rim light
                const rimLight = new THREE.DirectionalLight(0xff6b6b, 0.2);
                rimLight.position.set(0, 5, -10);
                this.scene.add(rimLight);
            }
            
            createStarfield() {
                const starGeometry = new THREE.BufferGeometry();
                const starCount = 1000;
                const positions = new Float32Array(starCount * 3);
                const colors = new Float32Array(starCount * 3);
                
                for (let i = 0; i < starCount * 3; i += 3) {
                    positions[i] = (Math.random() - 0.5) * 2000;
                    positions[i + 1] = (Math.random() - 0.5) * 2000;
                    positions[i + 2] = (Math.random() - 0.5) * 2000;
                    
                    // Mix of red and white stars for Sith theme
                    const isRedStar = Math.random() < 0.3;
                    colors[i] = isRedStar ? 1.0 : 0.8;     // R
                    colors[i + 1] = isRedStar ? 0.2 : 0.8; // G
                    colors[i + 2] = isRedStar ? 0.2 : 0.8; // B
                }
                
                starGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                starGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
                
                const starMaterial = new THREE.PointsMaterial({
                    size: 2,
                    transparent: true,
                    opacity: 0.8,
                    vertexColors: true
                });
                
                const stars = new THREE.Points(starGeometry, starMaterial);
                this.scene.add(stars);
            }
            
            async loadR2D2Model(url) {
                try {
                    console.log('Loading external R2-D2 model from:', url);
                    
                    // This would use GLTFLoader if available
                    // For now, we'll use the procedural model
                    console.log('External model loading not implemented, using procedural model');
                    return false;
                } catch (error) {
                    console.error('Error loading external model:', error);
                    return false;
                }
            }
            
            addGround() {
                const groundGeometry = new THREE.PlaneGeometry(20, 20);
                const groundMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0x220000,
                    transparent: true,
                    opacity: 0.8,
                    emissive: 0x110000,
                    emissiveIntensity: 0.1
                });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                ground.position.y = -2;
                ground.receiveShadow = true;
                this.scene.add(ground);
                
                // Add some ground details - glowing lines
                for (let i = 0; i < 5; i++) {
                    const lineGeometry = new THREE.PlaneGeometry(15, 0.1);
                    const lineMaterial = new THREE.MeshBasicMaterial({
                        color: 0xff0000,
                        transparent: true,
                        opacity: 0.3,
                        emissive: 0xff0000,
                        emissiveIntensity: 0.2
                    });
                    const line = new THREE.Mesh(lineGeometry, lineMaterial);
                    line.rotation.x = -Math.PI / 2;
                    line.position.y = -1.95;
                    line.position.x = (i - 2) * 3;
                    this.scene.add(line);
                }
            }
            
            showError(message) {
                const loading = document.getElementById('loading');
                loading.innerHTML = `
                    <h2 style="color: #ff0000;">❌ Error</h2>
                    <p>${message}</p>
                    <button onclick="location.reload()" style="
                        padding: 10px 20px;
                        background: #00d4ff;
                        color: #000;
                        border: none;
                        border-radius: 5px;
                        cursor: pointer;
                        margin-top: 10px;
                    ">Retry</button>
                `;
            }
            
            createR2D2Model() {
                try {
                    console.log('Creating detailed R2-D2 model...');
                    
                    // Create R2-D2 group
                    this.r2d2 = new THREE.Group();
                
                    // Main body (more detailed cylinder)
                    const bodyGeometry = new THREE.CylinderGeometry(1.5, 1.4, 3, 32);
                    const bodyMaterial = new THREE.MeshPhongMaterial({ 
                        color: 0xffffff,
                        shininess: 100,
                        emissive: 0x220000,
                        emissiveIntensity: 0.1
                    });
                    const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                    body.position.y = 0;
                    body.castShadow = true;
                    this.r2d2.add(body);
                    
                    // Body details - horizontal lines
                    for (let i = 0; i < 3; i++) {
                        const lineGeometry = new THREE.CylinderGeometry(1.52, 1.52, 0.1, 32);
                        const lineMaterial = new THREE.MeshPhongMaterial({ 
                            color: 0x333333,
                            emissive: 0x110000,
                            emissiveIntensity: 0.2
                        });
                        const line = new THREE.Mesh(lineGeometry, lineMaterial);
                        line.position.y = -1 + i * 1;
                        this.r2d2.add(line);
                    }
                    
                    // Dome (more detailed hemisphere)
                    const domeGeometry = new THREE.SphereGeometry(1.2, 32, 16, 0, Math.PI * 2, 0, Math.PI / 2);
                    const domeMaterial = new THREE.MeshPhongMaterial({ 
                        color: 0xffffff,
                        shininess: 100,
                        emissive: 0x220000,
                        emissiveIntensity: 0.1
                    });
                    const dome = new THREE.Mesh(domeGeometry, domeMaterial);
                    dome.position.y = 2.2;
                    dome.castShadow = true;
                    this.r2d2.add(dome);
                    
                    // Dome details - center circle
                    const centerGeometry = new THREE.CylinderGeometry(0.3, 0.3, 0.05, 16);
                    const centerMaterial = new THREE.MeshPhongMaterial({ 
                        color: 0x000000,
                        emissive: 0x220000,
                        emissiveIntensity: 0.3
                    });
                    const center = new THREE.Mesh(centerGeometry, centerMaterial);
                    center.position.y = 2.2;
                    center.position.z = 1.1;
                    this.r2d2.add(center);
                    
                    // Dome details - side circles
                    for (let i = 0; i < 3; i++) {
                        const angle = (i * Math.PI * 2) / 3;
                        const sideGeometry = new THREE.CylinderGeometry(0.15, 0.15, 0.05, 16);
                        const side = new THREE.Mesh(sideGeometry, centerMaterial);
                        side.position.y = 2.2;
                        side.position.x = Math.cos(angle) * 0.8;
                        side.position.z = Math.sin(angle) * 0.8 + 0.3;
                        side.rotation.x = Math.PI / 2;
                        side.rotation.z = angle;
                        this.r2d2.add(side);
                    }
                
                // Create dome panels
                this.createDomePanels();
                
                // Legs
                this.createLegs();
                
                // Add to scene
                this.scene.add(this.r2d2);
                
                    // Hide loading screen
                    document.getElementById('loading').style.display = 'none';
                    
                    console.log('R2-D2 model created successfully');
                } catch (error) {
                    console.error('Error creating R2-D2 model:', error);
                    this.showError('Failed to create R2-D2 model: ' + error.message);
                }
            }
            
            createDomePanels() {
                const panelGeometry = new THREE.BoxGeometry(0.3, 0.3, 0.1);
                const panelMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0x001122,
                    shininess: 50,
                    emissive: 0x000044,
                    emissiveIntensity: 0.2
                });
                
                // Create 16 panels in a 4x4 grid
                for (let i = 0; i < 16; i++) {
                    const panel = new THREE.Mesh(panelGeometry, panelMaterial);
                    
                    // Calculate position on dome surface
                    const row = Math.floor(i / 4);
                    const col = i % 4;
                    const angleX = (row - 1.5) * 0.3;
                    const angleY = (col - 1.5) * 0.3;
                    
                    panel.position.x = Math.sin(angleY) * Math.cos(angleX) * 1.1;
                    panel.position.y = 2.2 + Math.sin(angleX) * 1.1;
                    panel.position.z = Math.cos(angleY) * Math.cos(angleX) * 1.1;
                    
                    // Orient panel to face outward
                    panel.lookAt(
                        panel.position.x * 2,
                        panel.position.y * 2,
                        panel.position.z * 2
                    );
                    
                    panel.castShadow = true;
                    panel.userData = { 
                        index: i + 1, 
                        isOpen: false,
                        originalPosition: panel.position.clone()
                    };
                    
                    this.r2d2.add(panel);
                    this.panels.push(panel);
                }
                
                // Create panel buttons
                this.createPanelButtons();
            }
            
            createPanelButtons() {
                const panelGrid = document.getElementById('panelGrid');
                panelGrid.innerHTML = '';
                
                for (let i = 1; i <= 16; i++) {
                    const btn = document.createElement('button');
                    btn.className = 'panel-btn';
                    btn.textContent = i;
                    btn.addEventListener('click', () => this.togglePanel(i));
                    panelGrid.appendChild(btn);
                }
            }
            
            createLegs() {
                const legMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0xffffff,
                    emissive: 0x220000,
                    emissiveIntensity: 0.1
                });
                
                // Three legs with more detail
                const legPositions = [
                    { x: 0.8, z: 0 },
                    { x: -0.4, z: 0.7 },
                    { x: -0.4, z: -0.7 }
                ];
                
                legPositions.forEach((pos, index) => {
                    // Main leg
                    const legGeometry = new THREE.CylinderGeometry(0.12, 0.15, 2);
                    const leg = new THREE.Mesh(legGeometry, legMaterial);
                    leg.position.set(pos.x, -1.5, pos.z);
                    leg.castShadow = true;
                    this.r2d2.add(leg);
                    
                    // Foot
                    const footGeometry = new THREE.CylinderGeometry(0.2, 0.2, 0.1);
                    const foot = new THREE.Mesh(footGeometry, legMaterial);
                    foot.position.set(pos.x, -2.6, pos.z);
                    foot.castShadow = true;
                    this.r2d2.add(foot);
                    
                    // Leg joint
                    const jointGeometry = new THREE.SphereGeometry(0.15);
                    const joint = new THREE.Mesh(jointGeometry, legMaterial);
                    joint.position.set(pos.x, -0.5, pos.z);
                    this.r2d2.add(joint);
                });
                
                // Central leg support
                const supportGeometry = new THREE.CylinderGeometry(0.05, 0.05, 1);
                const support = new THREE.Mesh(supportGeometry, legMaterial);
                support.position.y = -1;
                support.castShadow = true;
                this.r2d2.add(support);
            }
            
            togglePanel(panelNum) {
                const panel = this.panels[panelNum - 1];
                const isOpen = panel.userData.isOpen;
                
                if (isOpen) {
                    this.closePanel(panelNum);
                } else {
                    this.openPanel(panelNum);
                }
                
                this.updatePanelButtons();
                this.updateStatus();
            }
            
            openPanel(panelNum) {
                const panel = this.panels[panelNum - 1];
                panel.userData.isOpen = true;
                
                // Animate panel opening
                const targetPosition = panel.userData.originalPosition.clone();
                targetPosition.multiplyScalar(1.3); // Move outward
                
                this.animatePanel(panel, targetPosition);
                this.addLogEntry(`Panel ${panelNum} opened`, 'success');
            }
            
            closePanel(panelNum) {
                const panel = this.panels[panelNum - 1];
                panel.userData.isOpen = false;
                
                // Animate panel closing
                this.animatePanel(panel, panel.userData.originalPosition);
                this.addLogEntry(`Panel ${panelNum} closed`, 'info');
            }
            
            animatePanel(panel, targetPosition) {
                const startPosition = panel.position.clone();
                const duration = 500; // ms
                const startTime = Date.now();
                
                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Easing function
                    const easeProgress = 1 - Math.pow(1 - progress, 3);
                    
                    panel.position.lerpVectors(startPosition, targetPosition, easeProgress);
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                };
                
                animate();
            }
            
            updatePanelButtons() {
                const buttons = document.querySelectorAll('.panel-btn');
                buttons.forEach((btn, index) => {
                    const panelNum = index + 1;
                    const panel = this.panels[panelNum - 1];
                    btn.classList.toggle('active', panel.userData.isOpen);
                });
            }
            
            sendCommand() {
                const commandInput = document.getElementById('commandInput');
                const command = commandInput.value.trim();
                
                if (!command) return;
                
                this.commandCount++;
                this.updateStatus();
                
                // Simulate command processing
                setTimeout(() => {
                    const success = this.processCommand(command);
                    this.addLogEntry(
                        `${success ? '✅' : '❌'} ${command} - ${success ? 'Command processed' : 'Command failed'}`,
                        success ? 'success' : 'error'
                    );
                }, 100);
                
                commandInput.value = '';
            }
            
            processCommand(command) {
                if (command.startsWith(':OP')) {
                    const panelNum = parseInt(command.substring(3));
                    if (panelNum === 0) {
                        // Open all panels
                        for (let i = 1; i <= 16; i++) {
                            this.openPanel(i);
                        }
                    } else if (panelNum >= 1 && panelNum <= 16) {
                        this.openPanel(panelNum);
                    }
                    return true;
                } else if (command.startsWith(':CL')) {
                    const panelNum = parseInt(command.substring(3));
                    if (panelNum === 0) {
                        // Close all panels
                        for (let i = 1; i <= 16; i++) {
                            this.closePanel(i);
                        }
                    } else if (panelNum >= 1 && panelNum <= 16) {
                        this.closePanel(panelNum);
                    }
                    return true;
                } else if (command.startsWith(':SE')) {
                    const seqNum = parseInt(command.substring(3));
                    this.addLogEntry(`🎬 Executing sequence ${seqNum}`, 'info');
                    return true;
                } else if (command.startsWith('*')) {
                    this.addLogEntry(`🌟 Holo Projector: ${command}`, 'info');
                    return true;
                } else if (command.startsWith('@')) {
                    this.addLogEntry(`📺 Display: ${command}`, 'info');
                    return true;
                } else if (command.startsWith('$')) {
                    this.addLogEntry(`🔊 Sound: ${command}`, 'info');
                    return true;
                } else if (command.startsWith('#')) {
                    this.addLogEntry(`⚙️ Setup: ${command}`, 'info');
                    return true;
                }
                
                return false;
            }
            
            loadWaveSequence() {
                const waveSequence = {
                    name: 'R2-D2 Wave',
                    steps: [
                        { time_ms: 200, action: 'closeAll' },
                        { time_ms: 300, action: 'open', panel: 1 },
                        { time_ms: 300, action: 'open', panel: 2 },
                        { time_ms: 300, action: 'open', panel: 3 },
                        { time_ms: 300, action: 'open', panel: 4 },
                        { time_ms: 600, action: 'closeAll' }
                    ]
                };
                
                this.currentSequence = waveSequence;
                this.addLogEntry(`✅ Loaded sequence: ${waveSequence.name}`, 'success');
                document.getElementById('startSequence').disabled = false;
            }
            
            loadScreamSequence() {
                const screamSequence = {
                    name: 'R2-D2 Scream',
                    steps: [
                        { time_ms: 200, action: 'closeAll' },
                        { time_ms: 1000, action: 'openAll' },
                        { time_ms: 1500, action: 'closeAll' }
                    ]
                };
                
                this.currentSequence = screamSequence;
                this.addLogEntry(`✅ Loaded sequence: ${screamSequence.name}`, 'success');
                document.getElementById('startSequence').disabled = false;
            }
            
            startSequence() {
                if (!this.currentSequence) {
                    this.addLogEntry('❌ No sequence loaded', 'error');
                    return;
                }
                
                this.isRunning = true;
                this.addLogEntry('🚀 Sequence started', 'success');
                this.updateSequenceButtons(true);
                this.runSequence();
            }
            
            stopSequence() {
                this.isRunning = false;
                this.addLogEntry('🛑 Sequence stopped', 'info');
                this.updateSequenceButtons(false);
            }
            
            runSequence() {
                if (!this.currentSequence || !this.isRunning) return;
                
                let stepIndex = 0;
                const totalSteps = this.currentSequence.steps.length;
                
                const runStep = () => {
                    if (!this.isRunning || stepIndex >= totalSteps) {
                        if (this.isRunning) {
                            this.addLogEntry('🎉 Sequence completed!', 'success');
                        }
                        this.updateSequenceButtons(false);
                        return;
                    }
                    
                    const step = this.currentSequence.steps[stepIndex];
                    this.addLogEntry(`Step ${stepIndex + 1}: ${step.action}`, 'info');
                    
                    // Execute step
                    if (step.action === 'openAll') {
                        for (let i = 1; i <= 16; i++) {
                            this.openPanel(i);
                        }
                    } else if (step.action === 'closeAll') {
                        for (let i = 1; i <= 16; i++) {
                            this.closePanel(i);
                        }
                    } else if (step.action === 'open' && step.panel) {
                        this.openPanel(step.panel);
                    } else if (step.action === 'close' && step.panel) {
                        this.closePanel(step.panel);
                    }
                    
                    stepIndex++;
                    setTimeout(runStep, step.time_ms);
                };
                
                runStep();
            }
            
            updateSequenceButtons(running) {
                document.getElementById('startSequence').disabled = running;
                document.getElementById('stopSequence').disabled = !running;
            }
            
            addLogEntry(message, type = 'info') {
                const logContainer = document.getElementById('commandLog');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // Keep only last 50 entries
                while (logContainer.children.length > 50) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            }
            
            updateStatus() {
                const openPanels = this.panels.filter(panel => panel.userData.isOpen).length;
                document.getElementById('panelCount').textContent = `${openPanels} / 16`;
                document.getElementById('commandCount').textContent = this.commandCount;
            }
            
            onWindowResize() {
                const container = document.getElementById('threejs-container');
                this.camera.aspect = container.clientWidth / container.clientHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(container.clientWidth, container.clientHeight);
            }
            
            animate() {
                this.animationId = requestAnimationFrame(() => this.animate());
                
                if (this.animationEnabled) {
                    // Rotate R2-D2 slowly
                    this.r2d2.rotation.y += 0.005;
                }
                
                this.controls.update();
                this.renderer.render(this.scene, this.camera);
            }
        }

        // Global functions for viewer controls
        function resetCamera() {
            simulator.camera.position.set(0, 5, 10);
            simulator.controls.reset();
        }

        function toggleWireframe() {
            simulator.wireframe = !simulator.wireframe;
            simulator.panels.forEach(panel => {
                panel.material.wireframe = simulator.wireframe;
            });
        }

        function toggleLights() {
            simulator.lightsOn = !simulator.lightsOn;
            simulator.scene.children.forEach(child => {
                if (child instanceof THREE.Light) {
                    child.visible = simulator.lightsOn;
                }
            });
        }

        function toggleAnimation() {
            simulator.animationEnabled = !simulator.animationEnabled;
        }

        // Initialize the simulator when the page loads
        let simulator;
        document.addEventListener('DOMContentLoaded', () => {
            simulator = new SITH3DSimulator();
        });
    </script>
</body>
</html>